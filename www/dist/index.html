<!doctype html>
<head>
</head>
<body>
	<h1>Detect your sex</h1>
	<h2>Using your voice</h2>
	<button id="startButton" onclick="start();">Start recording</button>
	<button id="detectButton" onclick="stop();" disabled>Detect</button>
	<a id="downloadAnchor" href="#" style="display: none">Download your recording</a>
	<div id="loadingIndicator" class="loader" style="display: none"></div>
	<span id="answer" style="display: block"></span>
	<style>
		.loader {
			border: 4px solid #f3f3f3;
			border-top: 4px solid #3498db;
			border-radius: 50%;
			width: 10px;
			height: 10px;
			animation: spin 2s linear infinite;
		}

		@keyframes spin {
			0% { transform: rotate(0deg); }
			100% { transform: rotate(360deg); }
		}
	</style>
	<script src="record.js"></script>
	<script>
		var audioContext = new AudioContext();
		var recorder = null;
		var userMedia = navigator.mediaDevices.getUserMedia({ audio: true, video: false });
		userMedia.then(function(stream) {
			var input = audioContext.createMediaStreamSource(stream);
			recorder = new Recorder(input);
		});
		
		function start() {
			var startButton = document.getElementById("startButton");
			startButton.disabled = true;
			var detectButton = document.getElementById("detectButton");
			detectButton.disabled = false;
			recorder.record();
		}

		function stop() {
			var detectButton = document.getElementById("detectButton");
			detectButton.disabled = true;
			var loadingIndicator = document.getElementById("loadingIndicator");
			loadingIndicator.style.display = "inline-block";
			recorder.stop();
			recorder.exportWAV(saveData);
		}

		function saveData(blob) {
			var audioUrl = window.URL.createObjectURL(blob);
			downloadAnchor = document.getElementById("downloadAnchor");
			downloadAnchor.href = audioUrl;
			downloadAnchor.style.display = "inline";
			var file = new File([blob], "recording.wav");
			var formData = new FormData();
			formData.append("file", file);
			var fileRequest = new XMLHttpRequest();
			fileRequest.onload = function() {
				var fileUrl = JSON.parse(fileRequest.responseText).link;
				var request = new XMLHttpRequest();
				request.onload = function() {
					console.log(request.responseText);
					answer = document.getElementById("answer");
					switch(request.responseText) {
						case "Female": answer.textContent = "You are female"; break;
						case "Male": answer.textContent = "You are male"; break;
						case "Internal server error": answer.textContent = "There was an error."; break;
					}
					
					var startButton = document.getElementById("startButton");
					startButton.disabled = false;
					var loadingIndicator = document.getElementById("loadingIndicator");
					loadingIndicator.style.display = "none";
				}
				request.send(fileRequest.responseText);
				request.send(fileUrl);
			}
			fileRequest.open("POST", "https://file.io", true);
			fileRequest.send(formData);
		}
	</script>
</body>
