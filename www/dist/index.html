<!doctype html>
<head>
</head>
<body>
	<h1>Detect </h1>
	<button onclick="start();">Start</button>
	<button onclick="stop();">Stop</button>
	<a id="downloadAnchor" href="#">Download s</a>
	<p id="answer" />
	<script src="record.js"></script>
	<script>
		var audioContext = new AudioContext();
		var recorder = null;
		var userMedia = navigator.mediaDevices.getUserMedia({ audio: true, video: false });
		//var rec = null;
		userMedia.then(function(stream) {
			//rec = new MediaRecorder(stream);
			//rec.ondataavailable = function(e) { console.log(e.data); saveData(e); };
			var input = audioContext.createMediaStreamSource(stream);
			recorder = new Recorder(input);
		});
		
		function start() {
			recorder.start();
		}

		function stop() {
			recorder.stop();
			recorder.exportWAV(saveData);
		}
		file = null;
		blo = null;
		function saveData(blob) {
			blo = blob;
			console.log(blob);
			var audioUrl = window.URL.createObjectURL(blob);
			downloadAnchor = document.getElementById('downloadAnchor');
			downloadAnchor.href = audioUrl;
			file = new File([blob], 'test.wav');
			var formData = new FormData();
			formData.append("file", file);
			var fileRequest = new XMLHttpRequest();
			fileRequest.onload = function() {
				var fileUrl = JSON.parse(fileRequest.responseText).link;
				var request = new XMLHttpRequest();
				request.onload = function() {
					answer = document.getElementById('answer');
					switch(request.responseText) {
						case '1': answer.innerHtml = 'female'; break;
						case '2': answer.innerHtml = 'male'; break;
					}
				}
				request.send(fileRequest.responseText);
				request.send(fileUrl);
			}
			fileRequest.open("POST", "https://file.io", true);
			fileRequest.send(formData);
		}
	</script>
</body>
